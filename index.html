<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leaf Notes OS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(180deg, #FFFFFF 0%, #F5F7FA 100%);
            min-height: 100vh;
            color: #1e293b;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; margin-block: 40px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.35); }
        body.dark ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); }
        body.dark ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.35); }

        /* --- DARK MODE --- */
        body.dark { background: #1a1a1a; color: #e2e8f0; }
        body.dark .glass-panel { background: rgba(40, 40, 40, 0.7); border-color: rgba(255,255,255,0.1); }
        body.dark .note-card { background: rgba(40, 40, 40, 0.6); border-color: rgba(255,255,255,0.05); }
        
        /* Dark Mode Map - Aurora Gradient Overlay */
        .globe-gradient-overlay {
            position: absolute; inset: 0; pointer-events: none; z-index: 1;
            opacity: 0; transition: opacity 1s ease;
        }
        body.dark .view-globe .globe-gradient-overlay {
            opacity: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(34, 211, 238, 0.25), transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.25), transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(34, 211, 238, 0.2), transparent 50%),
                radial-gradient(circle at 70% 20%, rgba(59, 130, 246, 0.2), transparent 50%);
            background-size: 150% 150%;
            filter: blur(60px);
            animation: aurora 20s ease infinite alternate;
            mix-blend-mode: screen;
        }
        @keyframes aurora {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        body.dark .toggle-active { background: #262626; color: #10b981; }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9) translateX(20px); }
            100% { opacity: 1; transform: scale(1) translateX(0); }
        }
        .animate-pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes gradientXY {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animate-gradient-border {
            background-size: 200% 200%;
            animation: gradientXY 6s ease infinite;
        }

        /* --- 4. UI ELEMENTS --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }
        
        .note-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
            background: rgba(255, 255, 255, 0.9);
        }

        .suggestions-list {
            position: absolute; top: 110%; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden; max-height: 300px; overflow-y: auto; z-index: 6000;
            animation: menuSlide 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            transform-origin: top center;
        }
        body.dark .suggestions-list { background: rgba(0, 0, 0, 0.3); border-color: rgba(255,255,255,0.1); }
        @keyframes menuSlide {
            from { opacity: 0; transform: translateY(-8px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .suggestion-item { padding: 10px 16px; cursor: pointer; font-size: 13px; color: #334155; font-weight: 500; transition: background 0.2s; }
        .suggestion-item:hover { background: rgba(255, 255, 255, 0.25); color: #0f172a; }
        body.dark .suggestion-item { color: #e2e8f0; }
        body.dark .suggestion-item:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }

        .note-marker {
            background: #10b981; border: 2px solid white; border-radius: 50%;
            width: 14px; height: 14px; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
            transition: all 0.2s ease; cursor: pointer;
        }
        .note-marker:hover { transform: scale(1.5); background: #059669; z-index: 9999; }
        .note-marker.read { background: #94a3b8; box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.2); }
        .note-marker.read:hover { background: #64748b; }

        .toggle-btn { transition: all 0.3s ease; }
        .toggle-active { background: white; color: #059669; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .toggle-inactive { background: transparent; color: #64748b; }
        
        #map-container { position: absolute; inset: 0; z-index: 0; opacity: 0; transition: opacity 0.6s ease; pointer-events: none; }
        .view-globe #map-container { opacity: 1; pointer-events: auto; }
        body:not(.dark) #map-container { background: #f0fdf4; }

        .leaflet-container { background: transparent !important; }
        .leaflet-tile-pane { transition: filter 0.5s ease; }
        
        /* Light Mode: Blue Lineart */
        body:not(.dark) .leaflet-tile-pane {
            mix-blend-mode: multiply;
            filter: brightness(0.9) contrast(1.4) sepia(0.5) hue-rotate(170deg) saturate(3);
        }
        /* Dark Mode: Blue Lineart (Screen blends black tiles into background) */
        body.dark .leaflet-tile-pane {
            mix-blend-mode: screen;
            filter: contrast(1.2) brightness(1.1) sepia(1) hue-rotate(190deg) saturate(2);
        }

        .notification-toast {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: #0f172a; color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 13px; font-weight: 500; z-index: 99999999; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            animation: slideDown 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); pointer-events: none;
        }
        @keyframes slideDown { from { transform: translate(-50%, -40px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        .cluster-marker {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #10b981;
            color: #059669;
            border-radius: 50%;
            font-weight: 700;
            font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer; transition: transform 0.2s ease;
        }
        .cluster-marker:hover { transform: scale(1.15); background: #fff; z-index: 10000; }

        .avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; background: #f1f5f9; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: cover; }
        .avatar-lg { width: 64px; height: 64px; font-size: 32px; border-width: 4px; }

        .path-draw {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: drawPath 2s ease-out forwards;
        }
        @keyframes drawPath { to { stroke-dashoffset: 0; } }
        [contentEditable]:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
            cursor: text;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .char-anim {
            display: inline-block;
            animation: fadeInUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // ICONS
        const IconLock = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>;
        const IconMail = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>;
        const IconPen = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><circle cx="11" cy="11" r="2"></circle></svg>;
        const IconCheck = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>;
        const IconX = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const IconTrash = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconShare = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>;
        const IconFile = ({ className="" }) => <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
        const IconSearch = () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const IconGrid = () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>;
        const IconGlobe = ({ size=16 }) => <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>;
        const IconLocation = () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const IconCloud = () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>;
        const IconUpload = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const IconFlag = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>;
        const IconBell = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></svg>;
        const IconUser = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const IconLogout = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const IconHeart = ({ size=20, fill=false }) => <svg width={size} height={size} viewBox="0 0 24 24" fill={fill ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>;
        const IconBookmark = ({ size=20, fill=false }) => <svg width={size} height={size} viewBox="0 0 24 24" fill={fill ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>;
        const IconMoon = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
        const IconBold = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>;
        const IconItalic = ({ size=20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg>;

        const AnimatedIconHome = ({ size=20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path className="path-draw" d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline className="path-draw" points="9 22 9 12 15 12 15 22" style={{animationDelay: '0.5s'}}></polyline>
            </svg>
        );
        const AnimatedIconGlobe = ({ size=20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle className="path-draw" cx="12" cy="12" r="10"></circle>
                <line className="path-draw" x1="2" y1="12" x2="22" y2="12" style={{animationDelay: '0.4s'}}></line>
                <path className="path-draw" d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" style={{animationDelay: '0.8s'}}></path>
            </svg>
        );

        const AnimatedText = ({ text }) => (
            <span className="flex">
                {text.split('').map((char, i) => (
                    <span key={i} className="char-anim" style={{animationDelay: `${i * 0.03}s`}}>{char === ' ' ? '\u00A0' : char}</span>
                ))}
            </span>
        );

        const CITIES = {
            // Countries
            "Afghanistan": [33.9391, 67.7100], "Albania": [41.1533, 20.1683], "Algeria": [28.0339, 1.6596], "Andorra": [42.5063, 1.5218],
            "Angola": [-11.2027, 17.8739], "Antigua and Barbuda": [17.0608, -61.7964], "Argentina": [-38.4161, -63.6167], "Armenia": [40.0691, 45.0382],
            "Australia": [-25.2744, 133.7751], "Austria": [47.5162, 14.5501], "Azerbaijan": [40.1431, 47.5769], "Bahamas": [25.0343, -77.3963],
            "Bahrain": [26.0667, 50.5577], "Bangladesh": [23.6850, 90.3563], "Barbados": [13.1939, -59.5432], "Belarus": [53.7098, 27.9534],
            "Belgium": [50.5039, 4.4699], "Belize": [17.1899, -88.4976], "Benin": [9.3077, 2.3158], "Bhutan": [27.5142, 90.4336],
            "Bolivia": [-16.2902, -63.5887], "Bosnia and Herzegovina": [43.9159, 17.6791], "Botswana": [-22.3285, 24.6849], "Brazil": [-14.2350, -51.9253],
            "Brunei": [4.5353, 114.7277], "Bulgaria": [42.7339, 25.4858], "Burkina Faso": [12.2383, -1.5616], "Burundi": [-3.3731, 29.9189],
            "Cabo Verde": [16.5388, -23.0418], "Cambodia": [12.5657, 104.9910], "Cameroon": [7.3697, 12.3547], "Canada": [56.1304, -106.3468],
            "Central African Republic": [6.6111, 20.9394], "Chad": [15.4542, 18.7322], "Chile": [-35.6751, -71.5430], "China": [35.8617, 104.1954],
            "Colombia": [4.5709, -74.2973], "Comoros": [-11.8750, 43.8722], "Congo (DRC)": [-4.0383, 21.7587], "Congo (Republic)": [-0.2280, 15.8277],
            "Costa Rica": [9.7489, -83.7534], "Croatia": [45.1000, 15.2000], "Cuba": [21.5218, -77.7812], "Cyprus": [35.1264, 33.4299],
            "Czechia": [49.8175, 15.4730], "Denmark": [56.2639, 9.5018], "Djibouti": [11.8251, 42.5903], "Dominica": [15.4150, -61.3710],
            "Dominican Republic": [18.7357, -70.1627], "Ecuador": [-1.8312, -78.1834], "Egypt": [26.8206, 30.8025], "El Salvador": [13.7942, -88.8965],
            "Equatorial Guinea": [1.6508, 10.2679], "Eritrea": [15.1794, 39.7823], "Estonia": [58.5953, 25.0136], "Eswatini": [-26.5225, 31.4659],
            "Ethiopia": [9.1450, 40.4897], "Fiji": [-17.7134, 178.0650], "Finland": [61.9241, 25.7482], "France": [46.2276, 2.2137],
            "Gabon": [-0.8037, 11.6094], "Gambia": [13.4432, -15.3101], "Georgia": [42.3154, 43.3569], "Germany": [51.1657, 10.4515],
            "Ghana": [7.9465, -1.0232], "Greece": [39.0742, 21.8243], "Grenada": [12.1165, -61.6790], "Guatemala": [15.7835, -90.2308],
            "Guinea": [9.9456, -9.6966], "Guinea-Bissau": [11.8037, -15.1804], "Guyana": [4.8604, -58.9302], "Haiti": [18.9712, -72.2852],
            "Honduras": [15.2000, -86.2419], "Hungary": [47.1625, 19.5033], "Iceland": [64.9631, -19.0208], "India": [20.5937, 78.9629],
            "Indonesia": [-0.7893, 113.9213], "Iran": [32.4279, 53.6880], "Iraq": [33.2232, 43.6793], "Ireland": [53.1424, -7.6921],
            "Israel": [31.0461, 34.8516], "Italy": [41.8719, 12.5674], "Ivory Coast": [7.5400, -5.5471], "Jamaica": [18.1096, -77.2975],
            "Japan": [36.2048, 138.2529], "Jordan": [30.5852, 36.2384], "Kazakhstan": [48.0196, 66.9237], "Kenya": [-0.0236, 37.9062],
            "Kiribati": [-3.3704, -168.7340], "Kuwait": [29.3117, 47.4818], "Kyrgyzstan": [41.2044, 74.7661], "Laos": [19.8563, 102.4955],
            "Latvia": [56.8796, 24.6032], "Lebanon": [33.8547, 35.8623], "Lesotho": [-29.6099, 28.2336], "Liberia": [6.4281, -9.4295],
            "Libya": [26.3351, 17.2283], "Liechtenstein": [47.1660, 9.5554], "Lithuania": [55.1694, 23.8813], "Luxembourg": [49.8153, 6.1296],
            "Madagascar": [-18.7669, 46.8691], "Malawi": [-13.2543, 34.3015], "Malaysia": [4.2105, 101.9758], "Maldives": [3.2028, 73.2207],
            "Mali": [17.5707, -3.9962], "Malta": [35.9375, 14.3754], "Marshall Islands": [7.1315, 171.1845], "Mauritania": [21.0079, -10.9408],
            "Mauritius": [-20.3484, 57.5522], "Mexico": [23.6345, -102.5528], "Micronesia": [7.4256, 150.5508], "Moldova": [47.4116, 28.3699],
            "Monaco": [43.7384, 7.4246], "Mongolia": [46.8625, 103.8467], "Montenegro": [42.7087, 19.3744], "Morocco": [31.7917, -7.0926],
            "Mozambique": [-18.6657, 35.5296], "Myanmar": [21.9162, 95.9560], "Namibia": [-22.9576, 18.4904], "Nauru": [-0.5228, 166.9315],
            "Nepal": [28.3949, 84.1240], "Netherlands": [52.1326, 5.2913], "New Zealand": [-40.9006, 174.8860], "Nicaragua": [12.8654, -85.2072],
            "Niger": [17.6078, 8.0817], "Nigeria": [9.0820, 8.6753], "North Korea": [40.3399, 127.5101], "North Macedonia": [41.6086, 21.7453],
            "Norway": [60.4720, 8.4689], "Oman": [21.5126, 55.9233], "Pakistan": [30.3753, 69.3451], "Palau": [7.5150, 134.5825],
            "Panama": [8.5380, -80.7821], "Papua New Guinea": [-6.3150, 143.9555], "Paraguay": [-23.4425, -58.4438], "Peru": [-9.1900, -75.0152],
            "Philippines": [12.8797, 121.7740], "Poland": [51.9194, 19.1451], "Portugal": [39.3999, -8.2245], "Qatar": [25.3548, 51.1839],
            "Romania": [45.9432, 24.9668], "Russia": [61.5240, 105.3188], "Rwanda": [-1.9403, 29.8739], "Saint Kitts and Nevis": [17.3578, -62.7830],
            "Saint Lucia": [13.9094, -60.9789], "Saint Vincent and the Grenadines": [12.9843, -61.2872], "Samoa": [-13.7590, -172.1046],
            "San Marino": [43.9424, 12.4578], "Sao Tome and Principe": [0.1864, 6.6131], "Saudi Arabia": [23.8859, 45.0792], "Senegal": [14.4974, -14.4524],
            "Serbia": [44.0165, 21.0059], "Seychelles": [-4.6796, 55.4920], "Sierra Leone": [8.4606, -11.7799], "Singapore": [1.3521, 103.8198],
            "Slovakia": [48.6690, 19.6990], "Slovenia": [46.1512, 14.9955], "Solomon Islands": [-9.6457, 160.1562], "Somalia": [5.1521, 46.1996],
            "South Africa": [-30.5595, 22.9375], "South Korea": [35.9078, 127.7669], "South Sudan": [6.8770, 31.3070], "Spain": [40.4637, -3.7492],
            "Sri Lanka": [7.8731, 80.7718], "Sudan": [12.8628, 30.2176], "Suriname": [3.9193, -56.0278], "Sweden": [60.1282, 18.6435],
            "Switzerland": [46.8182, 8.2275], "Syria": [34.8021, 38.9968], "Taiwan": [23.6978, 120.9605], "Tajikistan": [38.8610, 71.2761],
            "Tanzania": [-6.3690, 34.8888], "Thailand": [15.8700, 100.9925], "Timor-Leste": [-8.8742, 125.7275], "Togo": [8.6195, 0.8248],
            "Tonga": [-21.1790, -175.1982], "Trinidad and Tobago": [10.6918, -61.2225], "Tunisia": [33.8869, 9.5375], "Turkey": [38.9637, 35.2433],
            "Turkmenistan": [38.9697, 59.5563], "Tuvalu": [-7.1095, 177.6493], "Uganda": [1.3733, 32.2903], "Ukraine": [48.3794, 31.1656],
            "UAE": [23.4241, 53.8478], "United Kingdom": [55.3781, -3.4360], "United States": [37.0902, -95.7129], "Uruguay": [-32.5228, -55.7658],
            "Uzbekistan": [41.3775, 64.5853], "Vanuatu": [-15.3767, 166.9592], "Vatican City": [41.9029, 12.4534], "Venezuela": [6.4238, -66.5897],
            "Vietnam": [14.0583, 108.2772], "Yemen": [15.5527, 48.5164], "Zambia": [-13.1339, 27.8493], "Zimbabwe": [-19.0154, 29.1549],
            
            // Major Cities
            "Kabul, Afghanistan": [34.5553, 69.2075], "Tirana, Albania": [41.3275, 19.8187], "Algiers, Algeria": [36.7538, 3.0588],
            "Buenos Aires, Argentina": [-34.6037, -58.3816], "Yerevan, Armenia": [40.1872, 44.5152],
            "Sydney, Australia": [-33.8688, 151.2093], "Melbourne, Australia": [-37.8136, 144.9631],
            "Vienna, Austria": [48.2082, 16.3738], "Baku, Azerbaijan": [40.4093, 49.8671],
            "Dhaka, Bangladesh": [23.8103, 90.4125], "Brussels, Belgium": [50.8503, 4.3517],
            "Brasilia, Brazil": [-15.7975, -47.8919], "Rio de Janeiro, Brazil": [-22.9068, -43.1729], "Sao Paulo, Brazil": [-23.5505, -46.6333],
            "Sofia, Bulgaria": [42.6977, 23.3219], "Toronto, Canada": [43.6532, -79.3832], "Vancouver, Canada": [49.2827, -123.1207],
            "Santiago, Chile": [-33.4489, -70.6693], "Beijing, China": [39.9042, 116.4074], "Shanghai, China": [31.2304, 121.4737],
            "Bogota, Colombia": [4.7110, -74.0721], "Zagreb, Croatia": [45.8150, 15.9819], "Havana, Cuba": [23.1136, -82.3666],
            "Prague, Czechia": [50.0755, 14.4378], "Copenhagen, Denmark": [55.6761, 12.5683],
            "Cairo, Egypt": [30.0444, 31.2357], "Helsinki, Finland": [60.1699, 24.9384],
            "Paris, France": [48.8566, 2.3522], "Marseille, France": [43.2965, 5.3698], "Lyon, France": [45.7640, 4.8357],
            "Tbilisi, Georgia": [41.7151, 44.8271], "Berlin, Germany": [52.5200, 13.4050], "Munich, Germany": [48.1351, 11.5820],
            "Hamburg, Germany": [53.5511, 9.9937], "Frankfurt, Germany": [50.1109, 8.6821],
            "Athens, Greece": [37.9838, 23.7275], "Thessaloniki, Greece": [40.6401, 22.9444], "Budapest, Hungary": [47.4979, 19.0402],
            "Reykjavik, Iceland": [64.1466, -21.9426], "New Delhi, India": [28.6139, 77.2090], "Mumbai, India": [19.0760, 72.8777],
            "Jakarta, Indonesia": [-6.2088, 106.8456], "Tehran, Iran": [35.6892, 51.3890], "Baghdad, Iraq": [33.3152, 44.3661],
            "Dublin, Ireland": [53.3498, -6.2603], "Jerusalem, Israel": [31.7683, 35.2137], "Tel Aviv, Israel": [32.0853, 34.7818],
            "Rome, Italy": [41.9028, 12.4964], "Milan, Italy": [45.4642, 9.1900], "Naples, Italy": [40.8518, 14.2681],
            "Turin, Italy": [45.0703, 7.6869], "Venice, Italy": [45.4408, 12.3155], "Florence, Italy": [43.7696, 11.2558],
            "Tokyo, Japan": [35.6762, 139.6503], "Osaka, Japan": [34.6937, 135.5023], "Amman, Jordan": [31.9454, 35.9284],
            "Nairobi, Kenya": [-1.2921, 36.8219], "Seoul, South Korea": [37.5665, 126.9780],
            "Beirut, Lebanon": [33.8938, 35.5018], "Kuala Lumpur, Malaysia": [3.1390, 101.6869],
            "Mexico City, Mexico": [19.4326, -99.1332], "Casablanca, Morocco": [33.5731, -7.5898],
            "Kathmandu, Nepal": [27.7172, 85.3240], "Amsterdam, Netherlands": [52.3676, 4.9041],
            "Auckland, New Zealand": [-36.8485, 174.7633], "Lagos, Nigeria": [6.5244, 3.3792],
            "Oslo, Norway": [59.9139, 10.7522], "Karachi, Pakistan": [24.8607, 67.0011], "Lima, Peru": [-12.0464, -77.0428],
            "Manila, Philippines": [14.5995, 120.9842], "Warsaw, Poland": [52.2297, 21.0122], "Krakow, Poland": [50.0647, 19.9450],
            "Lisbon, Portugal": [38.7223, -9.1393], "Porto, Portugal": [41.1579, -8.6291], "Doha, Qatar": [25.2854, 51.5310],
            "Bucharest, Romania": [44.4268, 26.1025], "Moscow, Russia": [55.7558, 37.6173], "Saint Petersburg, Russia": [59.9343, 30.3351],
            "Riyadh, Saudi Arabia": [24.7136, 46.6753], "Belgrade, Serbia": [44.7866, 20.4489], "Singapore": [1.3521, 103.8198],
            "Cape Town, South Africa": [-33.9249, 18.4241], "Johannesburg, South Africa": [-26.2041, 28.0473],
            "Madrid, Spain": [40.4168, -3.7038], "Barcelona, Spain": [41.3851, 2.1734], "Valencia, Spain": [39.4699, -0.3763],
            "Stockholm, Sweden": [59.3293, 18.0686], "Zurich, Switzerland": [47.3769, 8.5417], "Geneva, Switzerland": [46.2044, 6.1432],
            "Taipei, Taiwan": [25.0330, 121.5654], "Bangkok, Thailand": [13.7563, 100.5018], "Istanbul, Turkey": [41.0082, 28.9784],
            "Kyiv, Ukraine": [50.4501, 30.5234], "Dubai, UAE": [25.2048, 55.2708], "London, UK": [51.5074, -0.1278],
            "New York, USA": [40.7128, -74.0060], "Los Angeles, USA": [34.0522, -118.2437], "Chicago, USA": [41.8781, -87.6298],
            "Houston, USA": [29.7604, -95.3698], "San Francisco, USA": [37.7749, -122.4194], "Miami, USA": [25.7617, -80.1918],
            "Ho Chi Minh City, Vietnam": [10.8231, 106.6297], "Hanoi, Vietnam": [21.0285, 105.8542]
        };

        const AuthModal = ({ onClose, onLogin, cloudUrl, initialMode='LOGIN', token=null, initialEmail='' }) => {
            const [mode, setMode] = useState(initialMode); // LOGIN, SIGNUP, FORGOT, UPDATE_PASSWORD
            const [email, setEmail] = useState(initialEmail);
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [msg, setMsg] = useState(null);
            const backdropRef = useRef(false);

            const httpUrl = cloudUrl.replace('wss://', 'https://').replace('ws://', 'http://');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true); setError(null); setMsg(null);
                try {
                    let endpoint = '/auth/login';
                    let body = { email, password };
                    
                    if (mode === 'SIGNUP') { endpoint = '/auth/signup'; body = { email, password, name }; }
                    if (mode === 'FORGOT') { endpoint = '/auth/reset-request'; body = { email }; }
                    if (mode === 'UPDATE_PASSWORD') { 
                        const actualToken = token || localStorage.getItem('leaf_session_token');
                        if (!actualToken) throw new Error("Session expired. Please login again.");
                        endpoint = '/auth/update-password'; 
                        body = { token: actualToken, password }; 
                    }

                    const res = await fetch(httpUrl + endpoint, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                    });
                    
                    // Handle non-JSON responses (like 404 from stale worker)
                    const text = await res.text();
                    let data;
                    try { data = JSON.parse(text); } 
                    catch (e) { throw new Error(`Server Error: ${text.substring(0, 20)}... (Run deploy.cmd)`); }
                    
                    if (!res.ok) throw new Error(data.error || "Request failed");

                    if (mode === 'LOGIN') {
                        onLogin(data.user, data.session);
                        onClose();
                    } else if (mode === 'SIGNUP') {
                        setMsg(`Confirmation link sent to ${email}! Please check your inbox.`);
                        setMode('LOGIN');
                    } else if (mode === 'FORGOT') {
                        setMsg(`Password reset link sent to ${email}!`);
                        setMode('LOGIN');
                    } else if (mode === 'UPDATE_PASSWORD') {
                        setMsg("Password updated successfully!");
                        setTimeout(() => onClose(), 1500);
                    }
                } catch (err) { setError(err.message); }
                setLoading(false);
            };

            return (
                <div className="absolute inset-0 z-[8000] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4" onMouseDown={e => { if(e.target === e.currentTarget) backdropRef.current = true; }} onClick={e => { if(e.target === e.currentTarget && backdropRef.current) onClose(); backdropRef.current = false; }}>
                    <div className="bg-white dark:bg-neutral-800 w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-pop-in" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800 dark:text-white">{mode === 'LOGIN' ? 'Welcome Back' : mode === 'SIGNUP' ? 'Create Account' : mode === 'UPDATE_PASSWORD' ? 'Set New Password' : 'Reset Password'}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><IconX /></button>
                        </div>
                        {error && <div className="mb-4 p-3 bg-rose-50 text-rose-600 text-xs rounded-lg">{error}</div>}
                        {msg && <div className="mb-4 p-3 bg-emerald-50 text-emerald-600 text-xs rounded-lg break-all">{msg}</div>}
                        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                            {mode === 'SIGNUP' && <input type="text" placeholder="Display Name" className="p-3 bg-slate-50 dark:bg-neutral-900 rounded-xl border border-slate-200 dark:border-neutral-700 outline-none focus:border-blue-500 dark:text-white" value={name} onChange={e => setName(e.target.value)} required />}
                            {mode !== 'UPDATE_PASSWORD' && <input type="email" placeholder="Email Address" className="p-3 bg-slate-50 dark:bg-neutral-900 rounded-xl border border-slate-200 dark:border-neutral-700 outline-none focus:border-blue-500 dark:text-white" value={email} onChange={e => setEmail(e.target.value)} required />}
                            {mode !== 'FORGOT' && <input type="password" placeholder="Password" className="p-3 bg-slate-50 dark:bg-neutral-900 rounded-xl border border-slate-200 dark:border-neutral-700 outline-none focus:border-blue-500 dark:text-white" value={password} onChange={e => setPassword(e.target.value)} required />}
                            <button disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/20 transition-transform active:scale-95 disabled:opacity-50">{loading ? 'Processing...' : (mode === 'LOGIN' ? 'Login' : mode === 'SIGNUP' ? 'Sign Up Free' : mode === 'UPDATE_PASSWORD' ? 'Update Password' : 'Send Reset Link')}</button>
                        </form>
                        <div className="mt-4 text-center text-xs text-slate-500">
                            {mode === 'LOGIN' && <><span className="cursor-pointer hover:text-blue-500" onClick={() => setMode('FORGOT')}>Forgot Password?</span> â€¢ <span className="cursor-pointer hover:text-blue-500" onClick={() => setMode('SIGNUP')}>Create Account</span></>}
                            {mode === 'SIGNUP' && <span className="cursor-pointer hover:text-blue-500" onClick={() => setMode('LOGIN')}>Already have an account? Login</span>}
                            {mode === 'FORGOT' && <span className="cursor-pointer hover:text-blue-500" onClick={() => setMode('LOGIN')}>Back to Login</span>}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('HOME');
            const [notification, setNotification] = useState(null);
            const [selectedNote, setSelectedNote] = useState(null);
            const notifTimeout = useRef(null);
            const [notifications, setNotifications] = useState([]);
            const [pendingFocus, setPendingFocus] = useState(null);
            const [showNotifList, setShowNotifList] = useState(false);
            const notifListTimer = useRef(null);
            const [ticker, setTicker] = useState(() => Date.now());
            const [zoomLevel, setZoomLevel] = useState(5);
            const [viewProfile, setViewProfile] = useState(null); // { name, avatar, id, isMe }
            const [profileTab, setProfileTab] = useState('NOTES'); // NOTES or SAVED
            const [isEditingName, setIsEditingName] = useState(false);
            const [editNameInput, setEditNameInput] = useState("");
            const editorRef = useRef(null);
            const searchTimeoutRef = useRef(null);
            const [showAuth, setShowAuth] = useState(false);
            const [authMode, setAuthMode] = useState('LOGIN');
            
            const [showLocationPicker, setShowLocationPicker] = useState(false);
            const [pickerCoords, setPickerCoords] = useState(null);
            const pickerMapRef = useRef(null);
            const searchContainerRef = useRef(null);

            const [iconKeys, setIconKeys] = useState({ home: 0, globe: 0 });
            const triggerAnim = (k) => setIconKeys(p => ({...p, [k]: p[k] + 1}));

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (searchContainerRef.current && !searchContainerRef.current.contains(e.target)) {
                        setSearchSuggestions(prev => prev.length > 0 ? [] : prev);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside, true);
                document.addEventListener('touchstart', handleClickOutside, true);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside, true);
                    document.removeEventListener('touchstart', handleClickOutside, true);
                };
            }, []);

            const [placeholder, setPlaceholder] = useState("");
            useEffect(() => {
                const text = "Share your thoughts with the world!";
                let charIdx = 0;
                let timer;
                
                const type = () => {
                    if (charIdx <= text.length) {
                        setPlaceholder(text.substring(0, charIdx) + "|");
                        charIdx++;
                        timer = setTimeout(type, 50);
                    } else {
                        // Blink cursor
                        let showCursor = true;
                        const blink = () => {
                            showCursor = !showCursor;
                            setPlaceholder(text + (showCursor ? "|" : ""));
                            timer = setTimeout(blink, 800);
                        };
                        blink();
                    }
                };
                type();
                return () => clearTimeout(timer);
            }, []);

            const [darkMode, setDarkMode] = useState(() => {
                try { return JSON.parse(localStorage.getItem('leaf_dark_mode')) || false; } catch { return false; }
            });

            useEffect(() => {
                const timer = setInterval(() => setTicker(Date.now()), 1000);
                
                // IP Location Check
                if (!localStorage.getItem('leaf_home_loc')) {
                    fetch('https://ipapi.co/json/')
                        .then(res => res.json())
                        .then(data => {
                            if (data.city && data.latitude && data.longitude) {
                                const newLoc = { name: `${data.city}, ${data.country_name}`, lat: data.latitude, lng: data.longitude };
                                setHomeLocation(newLoc);
                            }
                        }).catch(() => {});
                }

                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                localStorage.setItem('leaf_dark_mode', JSON.stringify(darkMode));
                if (darkMode) {
                    document.body.classList.add('dark');
                    document.documentElement.classList.add('dark');
                } else {
                    document.body.classList.remove('dark');
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            // Handle Supabase Auth Redirect (Email Confirmation)
            useEffect(() => {
                const hash = window.location.hash;
                if (hash && hash.includes('access_token')) {
                    const params = new URLSearchParams(hash.substring(1));
                    const accessToken = params.get('access_token');
                    const type = params.get('type');
                    if (accessToken) {
                        const httpUrl = cloudUrl.replace('wss://', 'https://').replace('ws://', 'http://');
                        fetch(httpUrl + '/auth/user', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: accessToken })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.user) {
                                setUserAccount(data.user);
                                localStorage.setItem('leaf_session_token', accessToken);
                                showNotification("Email verified! Logged in.");
                                window.history.replaceState(null, null, window.location.pathname);
                                if (type === 'recovery') {
                                    setAuthMode('UPDATE_PASSWORD');
                                    setShowAuth(true);
                                }
                            }
                        })
                        .catch(e => console.error(e));
                    }
                }
            }, [cloudUrl]);

            const flashNotifications = () => {
                setShowNotifList(true);
                if (notifListTimer.current) clearTimeout(notifListTimer.current);
                notifListTimer.current = setTimeout(() => setShowNotifList(false), 6000);
            };

            const showNotification = (msg) => {
                setNotification(msg);
                if (notifTimeout.current) clearTimeout(notifTimeout.current);
                notifTimeout.current = setTimeout(() => setNotification(null), 3000);
            };
            
            // --- IDENTITY & STATE (UPDATED FOR AUTH) ---
            const [userAccount, setUserAccount] = useState(() => {
                try { return JSON.parse(localStorage.getItem('leaf_user_account')); } catch { return null; }
            });
            const userId = userAccount ? userAccount.id : null;

            const [readNotes, setReadNotes] = useState(() => {
                try { return JSON.parse(localStorage.getItem('leaf_read_notes')) || []; } catch { return []; }
            });
            const [likedNotes, setLikedNotes] = useState(() => {
                try { return JSON.parse(localStorage.getItem('leaf_liked_notes')) || []; } catch { return []; }
            });

            // NOTES: Shared Data (Content, Lat, Lng, Owner)
            const [notes, setNotes] = useState(() => {
                try { return JSON.parse(localStorage.getItem('leaf_cached_notes')) || []; } catch { return []; }
            });

            const [cloudUrl, setCloudUrl] = useState(() => localStorage.getItem('leaf_cloud_url_v2') || "wss://leaf-notes-backend.thomasthanos111.workers.dev");
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const wsRef = useRef(null);

            const globalZ = useRef(1000);
            const nextZ = () => { globalZ.current += 1; return globalZ.current; };

            const [search, setSearch] = useState("");
            const [searchSuggestions, setSearchSuggestions] = useState([]);
            const [isSettingHome, setIsSettingHome] = useState(false);
            const [homeInput, setHomeInput] = useState("");
            const [homeSuggestions, setHomeSuggestions] = useState([]);
            const [homeLocation, setHomeLocation] = useState(() => {
                try { return JSON.parse(localStorage.getItem('leaf_home_loc')) || { name: "Athens, Greece", lat: 37.9838, lng: 23.7275 }; } catch { return { name: "Athens, Greece", lat: 37.9838, lng: 23.7275 }; }
            });

            const mapRef = useRef(null);
            const [mapReady, setMapReady] = useState(false);
            const markersRef = useRef({});

            useEffect(() => localStorage.setItem('leaf_cached_notes', JSON.stringify(notes)), [notes]);
            useEffect(() => localStorage.setItem('leaf_home_loc', JSON.stringify(homeLocation)), [homeLocation]);
            useEffect(() => localStorage.setItem('leaf_cloud_url_v2', cloudUrl), [cloudUrl]);
            useEffect(() => { if(userAccount) localStorage.setItem('leaf_user_account', JSON.stringify(userAccount)); else localStorage.removeItem('leaf_user_account'); }, [userAccount]);
            useEffect(() => localStorage.setItem('leaf_read_notes', JSON.stringify(readNotes)), [readNotes]);
            useEffect(() => localStorage.setItem('leaf_liked_notes', JSON.stringify(likedNotes)), [likedNotes]);

            // --- WEBSOCKET CONNECTION ---
            useEffect(() => {
                if (!cloudUrl) return;
                if (wsRef.current) wsRef.current.close();

                try {
                    const ws = new WebSocket(cloudUrl);
                    ws.onopen = () => setIsCloudConnected(true);
                    ws.onclose = () => setIsCloudConnected(false);
                    ws.onmessage = (event) => {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'SYNC_ALL') {
                            setNotes(msg.notes);
                        } else if (msg.type === 'CREATE') {
                            setNotes(prev => [...prev, msg.note]);
                            if (msg.note.published && msg.note.ownerId !== userId) {
                                showNotification("One new note");
                                setNotifications(prev => [{ id: msg.note.id, time: Date.now(), read: false }, ...prev]);
                                flashNotifications();
                            }
                        } else if (msg.type === 'UPDATE') {
                            // Only update data, ignore UI fields if they arrive
                            setNotes(prev => prev.map(n => n.id === msg.id ? { ...n, ...msg.updates } : n));
                            if (msg.updates.published) {
                                showNotification("One new note");
                                setNotifications(prev => [{ id: msg.id, time: Date.now(), read: false }, ...prev]);
                                flashNotifications();
                            }
                        } else if (msg.type === 'DELETE') {
                            setNotes(prev => prev.filter(n => n.id !== msg.id));
                        }
                    };
                    wsRef.current = ws;
                } catch (e) {
                    console.error("WS Error", e);
                }
                return () => { if (wsRef.current) wsRef.current.close(); };
            }, [cloudUrl]);

            useEffect(() => {
                if (view === 'GLOBE' && mapReady && pendingFocus && mapRef.current) {
                    const note = notes.find(n => n.id === pendingFocus);
                    if (note) {
                        if (!readNotes.includes(note.id)) setReadNotes(prev => [...prev, note.id]);
                        mapRef.current.flyTo([note.lat, note.lng], 8, { duration: 2.2, easeLinearity: 0.2 });
                        setSelectedNote(note);
                    }
                    setPendingFocus(null);
                }
            }, [view, mapReady, pendingFocus, notes]);

            const handleNotificationClick = (id) => {
                const note = notes.find(n => n.id === id);
                if (!note) return;
                if (!readNotes.includes(id)) setReadNotes(prev => [...prev, id]);
                setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
                
                if (view !== 'GLOBE') {
                    setPendingFocus(id);
                    setView('GLOBE');
                } else {
                    if (mapRef.current) {
                        mapRef.current.flyTo([note.lat, note.lng], 8, { duration: 2.2, easeLinearity: 0.2 });
                    }
                    setSelectedNote(note);
                }
            };

            const visibleNotes = useMemo(() => {
                // Show all published notes + my notes
                // Sort by date desc
                return notes
                    .filter(n => (n.published || n.ownerId === userId) && (n.reports || 0) < 10)
                    .sort((a, b) => b.id - a.id);
            }, [notes, userId]);

            // Init Map
            useEffect(() => {
                if (!mapRef.current) {
                    setTimeout(() => {
                        if (!document.getElementById('map-container')) return;
                        const map = L.map('map-container', { 
                            zoomControl: false, 
                            attributionControl: false, 
                            worldCopyJump: false, 
                            minZoom: 2,
                            maxBounds: [[-85, -Infinity], [85, Infinity]],
                            maxBoundsViscosity: 1.0
                        }).setView([homeLocation.lat, homeLocation.lng], 5);
                        const tileUrl = darkMode 
                            ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                            : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                        const layer = L.tileLayer(tileUrl, { noWrap: false }).addTo(map);
                        map.on('zoomend', () => setZoomLevel(map.getZoom()));
                        mapRef.current = map;
                        mapRef.current.layer = layer;
                        setMapReady(true);
                    }, 100);
                }
            }, [darkMode]);

            // Update tiles when dark mode changes without full re-init if possible
            useEffect(() => {
                if (mapRef.current && mapRef.current.layer) {
                    const tileUrl = darkMode 
                        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                        : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                    mapRef.current.layer.setUrl(tileUrl);
                }
            }, [darkMode]);

            // Sync Markers (Only for Globe View)
            useEffect(() => {
                if (view === 'GLOBE' && mapRef.current) {
                    const map = mapRef.current;
                    const validMarkerIds = new Set();
                    
                    // Clear old markers not in use (simple approach: clear all and redraw for clustering simplicity or track them)
                    // For clustering, it's easier to clear layer group. But we have markersRef.
                    // Let's do a full redraw strategy for simplicity when clustering changes.
                    Object.values(markersRef.current).forEach(m => m.remove());
                    markersRef.current = {};

                    const toRender = [];
                    visibleNotes.forEach(note => {
                        if (note.content && note.content.trim() !== "") toRender.push(note);
                    });

                    // Clustering Logic
                    const clusters = [];
                    const processed = new Set();
                    const CLUSTER_RADIUS = zoomLevel < 9 ? 1.5 : 0.0001; // Degrees

                    toRender.forEach(note => {
                        if (processed.has(note.id)) return;
                        
                        const cluster = [note];
                        processed.add(note.id);

                        if (zoomLevel < 9) {
                            toRender.forEach(other => {
                                if (!processed.has(other.id)) {
                                    const d = Math.sqrt(Math.pow(note.lat - other.lat, 2) + Math.pow(note.lng - other.lng, 2));
                                    if (d < CLUSTER_RADIUS) {
                                        cluster.push(other);
                                        processed.add(other.id);
                                    }
                                }
                            });
                        }
                        clusters.push(cluster);
                    });

                    clusters.forEach(cluster => {
                        // Render markers for current world and neighbors (left/right) for infinite scroll effect
                        [-1, 0, 1].forEach(worldIdx => {
                            const offset = worldIdx * 360;
                            if (cluster.length > 1) {
                                // Render Cluster
                                const lat = cluster.reduce((sum, n) => sum + n.lat, 0) / cluster.length;
                                const lng = (cluster.reduce((sum, n) => sum + n.lng, 0) / cluster.length) + offset;
                                const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="cluster-marker" style="width:30px;height:30px;">${cluster.length}</div>`, iconSize: [30, 30], iconAnchor: [15, 15] });
                                const marker = L.marker([lat, lng], { icon }).addTo(map);
                                marker.on('click', () => {
                                    const bounds = L.latLngBounds(cluster.map(n => [n.lat, n.lng + offset]));
                                    map.flyToBounds(bounds, { padding: [50, 50], maxZoom: 12, duration: 1.8, easeLinearity: 0.2 });
                                });
                                markersRef.current[`c_${lat}_${lng}_${worldIdx}`] = marker;
                            } else {
                                // Render Single
                                const note = cluster[0];
                                const isRead = readNotes.includes(note.id);
                                const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="note-marker ${isRead ? 'read' : ''}"></div>`, iconSize: [14, 14], iconAnchor: [7, 7] });
                                const marker = L.marker([note.lat, note.lng + offset], { icon }).addTo(map);
                                marker.on('click', () => {
                                    if (!readNotes.includes(note.id)) setReadNotes(prev => [...prev, note.id]);
                                    map.flyTo([note.lat, note.lng + offset], Math.max(map.getZoom(), 8), { duration: 2.2, easeLinearity: 0.2 });
                                    setSelectedNote(note);
                                });
                                markersRef.current[`${note.id}_${worldIdx}`] = marker;
                            }
                        });
                    });
                }
            }, [visibleNotes, view, mapReady, zoomLevel, readNotes]);

            useEffect(() => {
                // Auto-delete fallen notes if I own them
                notes.forEach(n => {
                    if (n.ownerId === userId && (n.reports || 0) >= 10) deleteNote(n.id);
                });
            }, [notes]);

            const createNote = (content) => {
                const finalLat = homeLocation.lat + (Math.random() * 0.05); 
                const finalLng = homeLocation.lng + (Math.random() * 0.05);
                const locName = homeLocation.name;

                let authorName = "Anonymous";
                if (userAccount) {
                    authorName = userAccount.name;
                } else if (homeLocation && homeLocation.name) {
                    const parts = homeLocation.name.split(',');
                    const country = parts[parts.length - 1].trim();
                    if (country) authorName = `${country}ian`;
                }

                const newNote = {
                    id: Date.now(),
                    ownerId: userId, // Mark as mine
                    content: content,
                    lat: finalLat, lng: finalLng, locationName: locName,
                    authorName: authorName,
                    authorAvatar: userAccount ? userAccount.avatar : "ðŸ‘¤",
                    published: true, reports: 0, likes: 0
                };

                setNotes(prev => [...prev, newNote]);

                if (wsRef.current && wsRef.current.readyState === 1) {
                    wsRef.current.send(JSON.stringify({ type: 'CREATE', note: newNote }));
                }
            };

            const updateNote = (id, updates) => {
                const dataUpdates = updates;
                if (Object.keys(dataUpdates).length > 0) {
                    setNotes(prev => prev.map(n => n.id === id ? { ...n, ...dataUpdates } : n));
                    if (wsRef.current && wsRef.current.readyState === 1) {
                        wsRef.current.send(JSON.stringify({ type: 'UPDATE', id, updates: dataUpdates }));
                    }
                }
            };

            const deleteNote = (id) => {
                setNotes(prev => prev.filter(n => n.id !== id));
                if (wsRef.current && wsRef.current.readyState === 1) {
                    wsRef.current.send(JSON.stringify({ type: 'DELETE', id }));
                }
            };

            const handlePostDraft = () => {
                if (!editorRef.current) return;
                const content = editorRef.current.innerHTML;
                if (!editorRef.current.innerText.trim()) return;
                
                createNote(content);
                editorRef.current.innerHTML = "";
                showNotification("Note posted!");
            };

            const handleFormat = (cmd) => {
                document.execCommand(cmd, false, null);
                if (editorRef.current) editorRef.current.focus();
            };

            const allLocations = useMemo(() => {
                const locs = new Set();
                // Prioritize locations from recent notes
                [...notes].reverse().forEach(n => { if(n.locationName) locs.add(n.locationName); });
                // Add static cities
                Object.keys(CITIES).forEach(c => locs.add(c));
                return Array.from(locs);
            }, [notes]);

            const handleSearchChange = (e) => {
                const val = e.target.value; setSearch(val);
                if (val.length === 0) { setSearchSuggestions([]); return; }

                // Local matches
                const localMatches = allLocations
                    .filter(c => c.toLowerCase().includes(val.toLowerCase()))
                    .slice(0, 5)
                    .map(name => ({ name, type: 'local' }));
                setSearchSuggestions(localMatches);

                // API Search
                if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);
                searchTimeoutRef.current = setTimeout(async () => {
                    if (val.length < 3) return;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`);
                        const data = await res.json();
                        const apiMatches = data.slice(0, 5).map(item => ({
                            name: item.display_name,
                            lat: parseFloat(item.lat),
                            lng: parseFloat(item.lon),
                            type: 'api'
                        }));
                        setSearchSuggestions(prev => {
                            const existing = new Set(prev.map(p => p.name));
                            return [...prev, ...apiMatches.filter(m => !existing.has(m.name))];
                        });
                    } catch (e) { console.error(e); }
                }, 600);
            };
            
            const handleSearchFocus = () => {
                if (!search) setSearchSuggestions(allLocations.slice(0, 8).map(name => ({ name, type: 'local' })));
            };

            const selectCitySearch = (item) => {
                setSearch(item.name); setSearchSuggestions([]); setView('GLOBE');
                
                if (item.type === 'api') {
                    if (mapRef.current) mapRef.current.flyTo([item.lat, item.lng], 10, {duration: 2.2, easeLinearity: 0.2});
                } else {
                    const cityName = item.name;
                    if (CITIES[cityName] && mapRef.current) {
                        mapRef.current.flyTo(CITIES[cityName], 6, {duration: 2.2, easeLinearity: 0.2});
                    } else {
                        const targetNote = notes.find(n => n.locationName === cityName);
                        if (targetNote && mapRef.current) {
                            mapRef.current.flyTo([targetNote.lat, targetNote.lng], 6, {duration: 2.2, easeLinearity: 0.2});
                        }
                    }
                }
            };

            const handlePickerAccept = async () => {
                if (pickerCoords) {
                    let name = "Pinned Location";
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pickerCoords.lat}&lon=${pickerCoords.lng}`);
                        const data = await res.json();
                        if (data.address) {
                            const parts = [];
                            if (data.address.city || data.address.town || data.address.village) parts.push(data.address.city || data.address.town || data.address.village);
                            if (data.address.country) parts.push(data.address.country);
                            if (parts.length > 0) name = parts.join(", ");
                        }
                    } catch (e) {}
                    
                    setHomeLocation({ name, lat: pickerCoords.lat, lng: pickerCoords.lng });
                    setShowLocationPicker(false);
                    setIsSettingHome(false);
                }
            };

            useEffect(() => {
                if (showLocationPicker) {
                    setTimeout(() => {
                        if (!document.getElementById('picker-map-container')) return;
                        if (pickerMapRef.current) pickerMapRef.current.remove();
                        
                        const map = L.map('picker-map-container', { attributionControl: false }).setView([homeLocation.lat, homeLocation.lng], 10);
                        const tileUrl = darkMode 
                            ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                            : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                        L.tileLayer(tileUrl).addTo(map);
                        
                        let marker = L.marker([homeLocation.lat, homeLocation.lng]).addTo(map);
                        setPickerCoords({ lat: homeLocation.lat, lng: homeLocation.lng });

                        map.on('click', (e) => {
                            const { lat, lng } = e.latlng;
                            if (marker) marker.setLatLng([lat, lng]);
                            else marker = L.marker([lat, lng]).addTo(map);
                            setPickerCoords({ lat, lng });
                        });

                        pickerMapRef.current = map;
                        setTimeout(() => map.invalidateSize(), 50);
                    }, 100);
                } else {
                    if (pickerMapRef.current) {
                        pickerMapRef.current.remove();
                        pickerMapRef.current = null;
                    }
                }
            }, [showLocationPicker]);

            const toggleSaveNote = async (noteId) => {
                if (!userAccount) {
                    setShowAuth(true);
                    return;
                }

                const saved = userAccount.saved || [];
                let newSaved;
                if (saved.includes(noteId)) {
                    newSaved = saved.filter(id => id !== noteId);
                    showNotification("Note removed from saved");
                } else {
                    newSaved = [...saved, noteId];
                    showNotification("Note saved to profile!");
                }
                const updatedUser = { ...userAccount, saved: newSaved };
                setUserAccount(updatedUser);
                
                // Sync to backend
                const httpUrl = cloudUrl.replace('wss://', 'https://').replace('ws://', 'http://');
                fetch(httpUrl + '/auth/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userAccount.email, updates: { saved: newSaved } }) });
            };

            const toggleLikeNote = (noteId) => {
                const isLiked = likedNotes.includes(noteId);
                const note = notes.find(n => n.id === noteId);
                if (!note) return;

                const newLikes = (note.likes || 0) + (isLiked ? -1 : 1);
                updateNote(noteId, { likes: Math.max(0, newLikes) });

                if (isLiked) setLikedNotes(prev => prev.filter(id => id !== noteId));
                else setLikedNotes(prev => [...prev, noteId]);
            };

            const handleHomeChange = (e) => {
                const val = e.target.value; setHomeInput(val);
                if (val.length > 1) setHomeSuggestions(Object.keys(CITIES).filter(c => c.toLowerCase().includes(val.toLowerCase())));
                else setHomeSuggestions([]);
            };
            const selectHomeCity = (cityName) => {
                const coords = CITIES[cityName];
                setHomeLocation({ name: cityName, lat: coords[0], lng: coords[1] });
                setHomeInput(""); setHomeSuggestions([]); setIsSettingHome(false);
            };

            const handleUpdateProfile = async () => {
                if (!editNameInput.trim()) return;
                const updated = { ...userAccount, name: editNameInput };
                setUserAccount(updated);
                setViewProfile(prev => ({ ...prev, name: editNameInput }));
                setIsEditingName(false);
                showNotification("Profile name updated!");
                
                const httpUrl = cloudUrl.replace('wss://', 'https://').replace('ws://', 'http://');
                fetch(httpUrl + '/auth/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userAccount.email, updates: { name: editNameInput } }) });
            };
            
            const handleLogout = () => {
                setUserAccount(null);
                setViewProfile(null);
                localStorage.removeItem('leaf_session_token');
                showNotification("Logged out");
            };

            const openProfile = (note) => {
                const isMe = note ? note.ownerId === userId : true;

                let guestName = 'Guest';
                if (!userAccount && homeLocation && homeLocation.name) {
                    const parts = homeLocation.name.split(',');
                    const country = parts[parts.length - 1].trim();
                    if (country) guestName = `${country}ian`;
                }

                const profileData = note ? {
                    id: note.ownerId, name: note.authorName || "Anonymous", avatar: note.authorAvatar || "ðŸ‘¤", isMe
                } : {
                    id: userAccount ? userAccount.id : 'guest', 
                    name: userAccount ? userAccount.name : guestName, 
                    avatar: userAccount ? userAccount.avatar : <IconUser size={32} />, 
                    isMe: true
                };
                setViewProfile(profileData);
                setProfileTab('NOTES');
            };

            return (
                <div className={`relative w-screen h-[100dvh] overflow-hidden ${view === 'GLOBE' ? 'view-globe' : ''}`}>
                    {notification && <div className="notification-toast">{notification}</div>}

                    {showAuth && <AuthModal onClose={() => setShowAuth(false)} onLogin={(u, s) => { setUserAccount(u); if(s) localStorage.setItem('leaf_session_token', s.access_token); showNotification(`Welcome, ${u.name}!`); }} cloudUrl={cloudUrl} initialMode={authMode} token={localStorage.getItem('leaf_session_token')} initialEmail={userAccount ? userAccount.email : ''} />}

                    {/* TOP BAR: Profile - Search - Notifications */}
                    <div className="absolute top-0 left-0 w-full flex items-center justify-between px-3 pt-4 z-[5000] pointer-events-none ui-layer">
                        
                        {/* Profile (Left) */}
                        <div className="pointer-events-auto">
                            <button onClick={() => openProfile(null)} className={`w-10 h-10 rounded-full flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/10 transition-all ${userAccount ? 'text-emerald-600' : 'text-slate-600 dark:text-slate-200'}`}>
                                {userAccount ? <div className="text-xl">{userAccount.avatar}</div> : <IconUser size={24} />}
                            </button>
                        </div>

                        {/* Search (Center) */}
                        {view === 'GLOBE' && (
                            <div ref={searchContainerRef} className="flex-1 mx-2 max-w-md pointer-events-auto relative group search-container">
                                <input type="text" placeholder="Search" className="bg-white/10 dark:bg-black/20 backdrop-blur-md border border-white/20 dark:border-white/10 text-slate-700 dark:text-slate-200 placeholder-slate-500 pl-10 pr-4 py-3 rounded-full outline-none w-full font-medium tracking-wide transition-all focus:scale-105 shadow-2xl text-sm" value={search} onChange={handleSearchChange} onFocus={handleSearchFocus} />
                                <div className="absolute inset-y-0 left-3 flex items-center text-slate-500"><IconSearch /></div>
                                {searchSuggestions.length > 0 && (
                                    <div className="suggestions-list" style={{top: '120%'}}>
                                        {searchSuggestions.map((item, idx) => (<div key={idx} className="suggestion-item" onClick={() => selectCitySearch(item)}>{item.name}</div>))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Notification (Right) */}
                        <div className="pointer-events-auto relative">
                            <button onClick={() => { setShowNotifList(!showNotifList); if(notifListTimer.current) clearTimeout(notifListTimer.current); }} className="w-10 h-10 rounded-full flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/10 transition-all relative text-slate-600 dark:text-slate-200">
                                <IconBell size={24} />
                                {notifications.some(n => !n.read) && <div className="absolute top-0 right-0 w-3 h-3 bg-rose-500 rounded-full border-2 border-white"></div>}
                            </button>
                        </div>
                    </div>

                    {/* SWIPE CONTAINER */}
                    <div className="absolute inset-0 flex transition-transform duration-1000 ease-[cubic-bezier(0.23,1,0.32,1)]" style={{ transform: view === 'HOME' ? 'translateX(0)' : 'translateX(-50%)', width: '200vw' }}>
                        
                        {/* HOME PANE (Left) */}
                        <div className={`w-screen h-full relative overflow-y-auto pt-20 transition-all duration-1000 ease-[cubic-bezier(0.23,1,0.32,1)] ${view === 'HOME' ? 'opacity-100 blur-none scale-100' : 'opacity-0 blur-xl scale-90'}`}>
                            <div className="max-w-xl mx-auto px-4 pb-32">
                                
                                {/* INPUT CARD */}
                                <div className="relative p-[2px] rounded-[28px] mb-8 group">
                                    <div className="absolute inset-0 bg-gradient-to-r from-cyan-400 via-blue-500 to-indigo-500 opacity-60 blur-md animate-gradient-border rounded-[28px]"></div>
                                    <div className="absolute inset-0 bg-gradient-to-r from-cyan-400 via-blue-500 to-indigo-500 opacity-40 animate-gradient-border rounded-[28px]"></div>
                                    
                                    <div className="relative note-card rounded-[26px] p-5 !bg-white dark:!bg-[#1a1a1a]">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="relative z-10">
                                                {!isSettingHome ? (
                                                    <button onClick={() => setIsSettingHome(true)} className="flex items-center gap-2 text-xs font-bold text-slate-400 hover:text-blue-500 uppercase tracking-wider transition-colors">
                                                        <IconLocation size={12} />
                                                        <span>{homeLocation.name}</span>
                                                    </button>
                                                ) : (
                                                    <div className="relative flex items-center gap-2">
                                                        <div className="relative">
                                                            <input autoFocus type="text" placeholder="Search city..." className="bg-slate-100 dark:bg-neutral-700 border-none rounded-xl px-4 py-2 text-sm font-bold text-slate-700 dark:text-slate-200 outline-none w-56 shadow-sm transition-all" value={homeInput} onChange={handleHomeChange} onBlur={() => setTimeout(() => setIsSettingHome(false), 200)} />
                                                            {homeSuggestions.length > 0 && (
                                                                <div className="absolute top-full left-0 w-64 bg-white dark:bg-neutral-800 border border-slate-100 dark:border-neutral-700 rounded-xl shadow-xl mt-2 max-h-48 overflow-y-auto z-20">
                                                                    {homeSuggestions.map(city => (<div key={city} className="px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 cursor-pointer border-b border-slate-50 dark:border-neutral-700/50 last:border-none" onMouseDown={() => selectHomeCity(city)}>{city}</div>))}
                                                                    {homeSuggestions.map((loc, idx) => (<div key={idx} className="px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 cursor-pointer border-b border-slate-50 dark:border-neutral-700/50 last:border-none" onMouseDown={() => selectHomeCity(loc)}>{loc.name}</div>))}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <button onMouseDown={(e) => { e.preventDefault(); setShowLocationPicker(true); }} className="p-2 bg-slate-100 dark:bg-neutral-700 rounded-xl hover:bg-blue-50 dark:hover:bg-blue-900/30 text-slate-500 hover:text-blue-500 transition-colors" title="Pick on Map"><IconGlobe size={18} /></button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div 
                                            ref={editorRef}
                                            contentEditable
                                            className="min-h-[100px] outline-none text-slate-700 dark:text-slate-200 text-base leading-relaxed"
                                            placeholder={placeholder}
                                        />
                                        <div className="flex justify-end items-center mt-4">
                                            <button 
                                                onClick={handlePostDraft}
                                                className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg shadow-blue-500/20 transition-all active:scale-95 flex items-center gap-2"
                                            >
                                                Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* GLOBE PANE (Right) */}
                        <div className={`w-screen h-full relative transition-all duration-1000 ease-[cubic-bezier(0.23,1,0.32,1)] ${view === 'GLOBE' ? 'opacity-100 blur-none scale-100' : 'opacity-0 blur-xl scale-90'}`}>
                            <div id="map-container" className="w-full h-full"></div>
                            <div className="globe-gradient-overlay"></div>
                        </div>
                    </div>

                    <div 
                        className={`absolute top-20 right-4 z-[5000] pointer-events-auto transition-all duration-300 origin-top-right ${showNotifList ? 'opacity-100 scale-100' : 'opacity-0 scale-95 pointer-events-none'}`}
                        onMouseEnter={() => { if(notifListTimer.current) clearTimeout(notifListTimer.current); }}
                        onMouseLeave={() => { if(showNotifList) notifListTimer.current = setTimeout(() => setShowNotifList(false), 2000); }}
                    >
                        <div className="glass-panel rounded-2xl p-2 w-64 max-h-[60vh] overflow-y-auto shadow-2xl flex flex-col gap-1">
                            <div className="px-3 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100 mb-1">Notifications</div>
                            {notifications.length === 0 && <div className="p-4 text-center text-xs text-slate-400">No new notes.</div>}
                            {notifications.map(n => {
                                const note = notes.find(nt => nt.id === n.id);
                                if (!note) return null;
                                const seconds = Math.max(0, Math.floor((ticker - n.time) / 1000));
                                const timeStr = seconds < 60 ? `${seconds}s ago` : `${Math.floor(seconds/60)}m ago`;
                                return (
                                    <div key={n.id + "_" + n.time} onClick={() => handleNotificationClick(n.id)} className={`p-3 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors flex items-center gap-3 border-l-2 ${n.read ? 'border-transparent opacity-60' : 'border-emerald-500 bg-emerald-50/30'}`}>
                                        <div className={`p-1.5 rounded-full ${n.read ? 'bg-slate-100 text-slate-400' : 'bg-emerald-100 text-emerald-600'}`}><IconGlobe size={14} /></div>
                                        <div className="flex flex-col">
                                            <span className={`text-xs ${n.read ? 'font-medium text-slate-600' : 'font-bold text-slate-800'}`}>New Note</span>
                                            <span className="text-[10px] text-slate-500 truncate w-32">{note.locationName}</span>
                                            <span className="text-[9px] text-slate-400 font-mono">{timeStr}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[5000] pointer-events-auto">
                        <div className="rounded-full p-1.5 flex relative shadow-2xl w-64 bg-white/10 dark:bg-black/20 backdrop-blur-md border border-white/20 dark:border-white/10">
                            <div className={`absolute top-1.5 bottom-1.5 rounded-full bg-white/40 dark:bg-white/10 backdrop-blur-md shadow-sm transition-all duration-300 ease-[cubic-bezier(0.23,1,0.32,1)] ${view === 'HOME' ? 'left-1.5 w-[calc(50%-6px)]' : 'left-[50%] w-[calc(50%-6px)]'}`}></div>
                            
                            <button onClick={() => { setView('HOME'); triggerAnim('home'); }} className={`relative z-10 flex-1 flex items-center justify-center gap-2 py-2 rounded-full text-xs font-bold uppercase tracking-wide transition-colors duration-300 ${view === 'HOME' ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-400'}`}>
                                <AnimatedIconHome key={`icon-home-${iconKeys.home}`} /> <AnimatedText key={`text-home-${iconKeys.home}`} text="Home" />
                            </button>
                            <button onClick={() => { setView('GLOBE'); triggerAnim('globe'); }} className={`relative z-10 flex-1 flex items-center justify-center gap-2 py-2 rounded-full text-xs font-bold uppercase tracking-wide transition-colors duration-300 ${view === 'GLOBE' ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-400'}`}>
                                <AnimatedIconGlobe key={`icon-globe-${iconKeys.globe}`} /> <AnimatedText key={`text-globe-${iconKeys.globe}`} text="Public" />
                            </button>
                        </div>
                    </div>

                    {selectedNote && (
                        <div className="absolute inset-0 z-[6000] bg-black/30 backdrop-blur-sm flex items-center justify-center pointer-events-auto" onClick={() => setSelectedNote(null)}>
                            <div className="glass-panel p-6 rounded-2xl w-80 animate-pop-in shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setSelectedNote(null)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700"><IconX /></button>
                                
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="avatar">{selectedNote.authorAvatar || "ðŸ‘¤"}</div>
                                    <div className="flex flex-col">
                                        <span className="text-sm font-bold text-slate-800 dark:text-slate-200">{selectedNote.authorName}</span>
                                        <span className="text-xs text-slate-500">{selectedNote.locationName}</span>
                                    </div>
                                </div>
                                
                                <div className="text-sm text-slate-600 dark:text-slate-300 leading-relaxed mb-4 max-h-60 overflow-y-auto" dangerouslySetInnerHTML={{__html: selectedNote.content}} />
                                
                                <div className="flex items-center justify-between pt-3 border-t border-slate-100 dark:border-slate-700">
                                    <span className="text-xs text-slate-400">{new Date(selectedNote.id).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    <div className="flex gap-2">
                                        <button onClick={() => toggleSaveNote(selectedNote.id)} className={`text-slate-400 hover:text-emerald-500 ${userAccount && userAccount.saved && userAccount.saved.includes(selectedNote.id) ? 'text-emerald-500' : ''}`}>
                                            <IconBookmark size={16} fill={userAccount && userAccount.saved && userAccount.saved.includes(selectedNote.id)} />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showLocationPicker && (
                        <div className="absolute inset-0 z-[7000] bg-black/50 backdrop-blur-sm flex items-center justify-center pointer-events-auto">
                            <div className="bg-white dark:bg-neutral-800 p-4 rounded-2xl shadow-2xl w-[90%] max-w-lg animate-pop-in flex flex-col gap-4">
                                <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><IconLocation /> Pin Location</h3>
                                <div id="picker-map-container" className="w-full h-64 rounded-xl bg-slate-100 overflow-hidden relative z-10 border border-slate-200 dark:border-neutral-700"></div>
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLocationPicker(false)} className="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded-lg transition-colors">Cancel</button>
                                    <button onClick={handlePickerAccept} className="px-6 py-2 text-sm font-bold text-white bg-blue-500 hover:bg-blue-600 rounded-lg shadow-lg shadow-blue-500/30 transition-colors">Accept</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {viewProfile && (
                        <div className="absolute inset-0 z-[6000] bg-black/30 backdrop-blur-sm flex items-center justify-center pointer-events-auto" onClick={() => setViewProfile(null)}>
                            <div className="glass-panel p-6 rounded-2xl w-80 animate-pop-in shadow-2xl flex flex-col items-center relative transition-all" onClick={e => e.stopPropagation()}>
                                <button onClick={() => { setViewProfile(null); setIsEditingName(false); }} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700"><IconX /></button>
                                <div className="avatar avatar-lg mb-3">{viewProfile.avatar}</div>
                                
                                {viewProfile.isMe && isEditingName ? (
                                    <div className="flex items-center gap-2 mb-4">
                                        <input autoFocus type="text" className="bg-slate-100 border border-slate-300 rounded px-2 py-1 text-sm font-bold text-slate-800 w-40 outline-none focus:border-emerald-500" value={editNameInput} onChange={e => setEditNameInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleUpdateProfile()} />
                                        <button onClick={handleUpdateProfile} className="p-1 bg-emerald-500 text-white rounded hover:bg-emerald-600"><IconCheck size={16}/></button>
                                        <button onClick={() => setIsEditingName(false)} className="p-1 bg-slate-200 text-slate-500 rounded hover:bg-slate-300"><IconX size={16}/></button>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-2 mb-4">
                                        <h2 className="text-xl font-bold text-slate-800 dark:text-white">{viewProfile.name}</h2>
                                        {viewProfile.isMe && userAccount && <button onClick={() => { setIsEditingName(true); setEditNameInput(viewProfile.name); }} className="text-slate-400 hover:text-emerald-600"><IconPen size={14} /></button>}
                                        {viewProfile.isMe && (userAccount ? 
                                            <button onClick={handleLogout} className="ml-2 text-rose-400 hover:text-rose-600" title="Logout"><IconLogout size={16} /></button> :
                                            <button onClick={() => { setViewProfile(null); setAuthMode('LOGIN'); setShowAuth(true); }} className="ml-2 text-emerald-500 hover:text-emerald-600 text-xs font-bold">Login</button>
                                        )}
                                    </div>
                                )}
                                
                                {viewProfile.isMe && (
                                    <div className="w-full mb-4 bg-white dark:bg-neutral-800 rounded-xl p-3 border border-slate-100 dark:border-slate-700">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Current Location</span>
                                            {!isSettingHome && <button onClick={() => setIsSettingHome(true)} className="text-xs text-indigo-500 font-bold hover:underline">Change</button>}
                                        </div>
                                        {!isSettingHome ? (
                                            <div className="flex items-center gap-2 text-slate-700 font-medium text-sm"><IconLocation size={14} className="text-indigo-500" />{homeLocation.name}</div>
                                        ) : (
                                            <div className="relative">
                                                <input autoFocus type="text" placeholder="City..." className="w-full bg-white border border-slate-200 rounded px-2 py-1 text-sm outline-none focus:border-indigo-500" value={homeInput} onChange={handleHomeChange} onBlur={() => setTimeout(() => setIsSettingHome(false), 200)} />
                                                {homeSuggestions.length > 0 && (
                                                    <div className="absolute top-full left-0 w-full bg-white border border-slate-100 rounded-lg shadow-xl mt-1 max-h-32 overflow-y-auto z-10">
                                                        {homeSuggestions.map(city => (<div key={city} className="px-3 py-2 text-xs text-slate-600 hover:bg-indigo-50 cursor-pointer" onMouseDown={() => selectHomeCity(city)}>{city}</div>))}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {viewProfile.isMe && (
                                    <div className="w-full mb-4 flex items-center justify-between bg-white dark:bg-neutral-800 rounded-xl p-3 border border-slate-100 dark:border-slate-700">
                                        <span className="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2"><IconMoon size={14} /> Dark Mode</span>
                                        <button onClick={() => setDarkMode(!darkMode)} className={`w-10 h-5 rounded-full relative transition-colors ${darkMode ? 'bg-emerald-500' : 'bg-slate-300'}`}><div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${darkMode ? 'left-6' : 'left-1'}`}></div></button>
                                    </div>
                                )}

                                {viewProfile.isMe && userAccount && (
                                    <div className="w-full mb-4 flex items-center justify-between bg-white dark:bg-neutral-800 rounded-xl p-3 border border-slate-100 dark:border-slate-700">
                                        <span className="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2"><IconLock size={14} /> Security</span>
                                        <button onClick={() => { 
                                            setViewProfile(null); 
                                            setAuthMode('FORGOT'); 
                                            setShowAuth(true); 
                                        }} className="text-xs font-bold text-blue-500 hover:underline">Reset Password</button>
                                    </div>
                                )}

                                <div className="w-full mb-4">
                                    <div className="flex border-b border-slate-200 mb-2">
                                        <button onClick={() => setProfileTab('NOTES')} className={`flex-1 pb-2 text-xs font-bold uppercase tracking-wide ${profileTab === 'NOTES' ? 'text-emerald-600 border-b-2 border-emerald-500' : 'text-slate-400'}`}>Notes</button>
                                        {viewProfile.isMe && <button onClick={() => setProfileTab('SAVED')} className={`flex-1 pb-2 text-xs font-bold uppercase tracking-wide ${profileTab === 'SAVED' ? 'text-emerald-600 border-b-2 border-emerald-500' : 'text-slate-400'}`}>Saved</button>}
                                    </div>
                                    
                                    <div className="max-h-32 overflow-y-auto flex flex-col gap-1">
                                        {profileTab === 'NOTES' && notes.filter(n => n.ownerId === viewProfile.id && n.published).length === 0 && <div className="text-xs text-slate-400 italic text-center py-2">No public notes yet.</div>}
                                        {profileTab === 'NOTES' && notes.filter(n => n.ownerId === viewProfile.id && n.published).map(n => (
                                            <div key={n.id} onClick={() => { setViewProfile(null); handleNotificationClick(n.id); }} className="text-xs p-2 bg-slate-50 rounded cursor-pointer hover:bg-emerald-50 truncate">{n.content || "Empty Note"}</div>
                                        ))}

                                        {profileTab === 'SAVED' && viewProfile.isMe && (!userAccount || !userAccount.saved || userAccount.saved.length === 0) && <div className="text-xs text-slate-400 italic text-center py-2">No saved notes.</div>}
                                        {profileTab === 'SAVED' && viewProfile.isMe && userAccount && userAccount.saved && notes.filter(n => userAccount.saved.includes(n.id)).map(n => (
                                            <div key={n.id} onClick={() => { setViewProfile(null); handleNotificationClick(n.id); }} className="text-xs p-2 bg-slate-50 rounded cursor-pointer hover:bg-emerald-50 truncate">{n.content || "Empty Note"}</div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
