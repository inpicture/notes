{
  "version": 3,
  "sources": ["../../../src/worker.js"],
  "sourceRoot": "C:\\Users\\anton\\AppData\\Local\\Programs\\Microsoft VS Code\\notes\\.wrangler\\tmp\\deploy-KzOPmF",
  "sourcesContent": ["\r\nexport class NotesBackend {\r\n  constructor(state, env) {\r\n    this.state = state;\r\n    this.env = env;\r\n    this.sessions = new Set();\r\n    this.notes = [];\r\n    // Load from storage on startup\r\n    this.state.blockConcurrencyWhile(async () => {\r\n      let stored = await this.state.storage.get(\"notes\");\r\n      this.notes = stored || [];\r\n    });\r\n  }\r\n\r\n  // Handle HTTP requests for Auth and WebSocket upgrades\r\n  async fetch(request) {\r\n    const url = new URL(request.url);\r\n\r\n    // --- AUTH ENDPOINTS ---\r\n    if (request.method === \"POST\" && url.pathname.startsWith(\"/auth/\")) {\r\n      const body = await request.json();\r\n      const users = await this.state.storage.get(\"users\") || {};\r\n\r\n      if (url.pathname === \"/auth/signup\") {\r\n        const { email, password, name, avatar } = body;\r\n        if (users[email] && users[email].verified) return new Response(JSON.stringify({ error: \"User already exists\" }), { status: 400 });\r\n        \r\n        // Generate Code\r\n        const code = Math.floor(100000 + Math.random() * 900000).toString();\r\n        users[email] = { password, code, verified: false, created: Date.now(), name: name || \"Explorer\", avatar: avatar || \"\uD83C\uDF31\", saved: [] };\r\n        await this.state.storage.put(\"users\", users);\r\n        \r\n        // RESEND.COM API SENDING\r\n        try {\r\n            await this.sendViaResend(email, code);\r\n            return new Response(JSON.stringify({ success: true })); \r\n        } catch (e) { return new Response(JSON.stringify({ error: \"Email failed: \" + e.message }), { status: 500 }); }\r\n      }\r\n\r\n      if (url.pathname === \"/auth/verify\") {\r\n        const { email, code } = body;\r\n        if (!users[email]) return new Response(JSON.stringify({ error: \"User not found\" }), { status: 400 });\r\n        if (users[email].code !== code) return new Response(JSON.stringify({ error: \"Invalid code\" }), { status: 400 });\r\n        \r\n        users[email].verified = true;\r\n        delete users[email].code; // Remove code after use\r\n        await this.state.storage.put(\"users\", users);\r\n        return new Response(JSON.stringify({ success: true, user: { email, name: users[email].name, avatar: users[email].avatar, saved: users[email].saved || [] } }));\r\n      }\r\n\r\n      if (url.pathname === \"/auth/login\") {\r\n        const { email, password } = body;\r\n        const user = users[email];\r\n        if (!user || !user.verified || user.password !== password) return new Response(JSON.stringify({ error: \"Invalid credentials\" }), { status: 401 });\r\n        return new Response(JSON.stringify({ success: true, user: { email, name: user.name, avatar: user.avatar, saved: user.saved || [] } }));\r\n      }\r\n\r\n      if (url.pathname === \"/auth/update\") {\r\n        const { email, updates } = body;\r\n        if (!users[email]) return new Response(JSON.stringify({ error: \"User not found\" }), { status: 404 });\r\n        if (updates.name) users[email].name = updates.name;\r\n        await this.state.storage.put(\"users\", users);\r\n        return new Response(JSON.stringify({ success: true }));\r\n      }\r\n    }\r\n\r\n    // --- WEBSOCKET ---\r\n    if (request.headers.get(\"Upgrade\") !== \"websocket\") {\r\n        // If not auth and not websocket, 404\r\n        return new Response(\"Not found\", { status: 404 });\r\n    }\r\n\r\n    const pair = new WebSocketPair();\r\n    const [client, server] = Object.values(pair);\r\n    \r\n    server.accept();\r\n    this.sessions.add(server);\r\n\r\n    // Send initial state\r\n    server.send(JSON.stringify({ type: 'SYNC_ALL', notes: this.notes }));\r\n\r\n    server.addEventListener('message', async msg => {\r\n      const data = JSON.parse(msg.data);\r\n      \r\n      // Update local state\r\n      if (data.type === 'CREATE') this.notes.push(data.note);\r\n      if (data.type === 'UPDATE') this.notes = this.notes.map(n => n.id === data.id ? { ...n, ...data.updates } : n);\r\n      if (data.type === 'DELETE') this.notes = this.notes.filter(n => n.id !== data.id);\r\n\r\n      // Save to Durable Object Storage\r\n      await this.state.storage.put(\"notes\", this.notes);\r\n\r\n      // Broadcast to others\r\n      this.sessions.forEach(s => {\r\n        if (s !== server && s.readyState === 1) s.send(msg.data);\r\n      });\r\n    });\r\n\r\n    server.addEventListener('close', () => this.sessions.delete(server));\r\n    return new Response(null, { status: 101, webSocket: client });\r\n  }\r\n\r\n  async sendViaResend(to, code) {\r\n    const res = await fetch('https://api.resend.com/emails', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': 'Bearer re_FnjXRdQC_Mqa6GvYQ31e2DnXk56nKPqBd',\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        from: 'onboarding@resend.dev',\r\n        to: to,\r\n        subject: 'Leaf Notes Verification Code',\r\n        html: `<div style=\"font-family:sans-serif; padding:20px; text-align:center;\"><h1>Welcome to Leaf Notes</h1><p>Your code is:</p><h2 style=\"background:#f0fdf4; color:#166534; display:inline-block; padding:10px 20px; border-radius:10px;\">${code}</h2></div>`\r\n      })\r\n    });\r\n    \r\n    if (!res.ok) {\r\n        const text = await res.text();\r\n        throw new Error(\"Resend API Error: \" + text);\r\n    }\r\n  }\r\n}\r\n\r\nexport default {\r\n  async fetch(request, env) {\r\n    // Route everyone to the same \"global\" room for this demo\r\n    const id = env.NOTES_ROOM.idFromName(\"global\");\r\n    const stub = env.NOTES_ROOM.get(id);\r\n    return stub.fetch(request);\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": []
}
